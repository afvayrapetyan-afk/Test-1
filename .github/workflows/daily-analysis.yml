name: Daily AI Analysis

on:
  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00 UTC (9:00 –ø–æ –ú–æ—Å–∫–≤–µ)
  schedule:
    - cron: '0 6 * * *'

  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é
  workflow_dispatch:
    inputs:
      ideas_count:
        description: 'Number of ideas to generate (3-10)'
        required: false
        default: '5'

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Daily Analysis
        run: |
          echo "üåÖ Starting Daily AI Analysis..."
          echo "Time: $(date)"

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.API_BASE_URL }}/api/v1/cron/daily-analysis?ideas_count=${{ github.event.inputs.ideas_count || '5' }}" \
            -H "Content-Type: application/json" \
            -H "X-Cron-Secret: ${{ secrets.CRON_SECRET }}" \
            --max-time 300)

          # –†–∞–∑–¥–µ–ª—è–µ–º –æ—Ç–≤–µ—Ç –∏ –∫–æ–¥
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response code: $http_code"
          echo "Response body: $body"

          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "‚úÖ Analysis completed successfully!"
            echo "$body" | jq '.' 2>/dev/null || echo "$body"
          else
            echo "‚ùå Analysis failed with code: $http_code"
            exit 1
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Daily analysis failed!"
          # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram/Slack
